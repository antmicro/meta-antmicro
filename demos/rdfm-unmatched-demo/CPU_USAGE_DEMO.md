### RDFM telemetry CPU usage gathering demo

Recommended reading before running this demo: [RDFM's demo Kafka deployment](https://github.com/antmicro/rdfm/blob/636fcf9ab5a695852b18c2cea2c5f7e0a807b412/server/deploy/pubsub-demo/README.md)

#### Yocto build

To build an image with the demo, add the following class to your `local.conf`:

```
INHERIT += " \
    rdfm-telemetry-demo \
    # ...
"
```

And run:

```sh
target=renodeunmatched
MACHINE=$target bitbake rdfm-image-minimal # not going to use upgrades, so upgraded image not necessary
```

The above entry in `INHERIT` is a replacement for `rdfm-full` and will build the target image with the `rdfm-telemetry-cpu-usage` recipe, which does a few things:

* Appends to `rdfm-client` recipe to generate an `rsa.pem` inside the data directory on the BSP. This makes daemonizing in Renode take less time.
* Installs CA certificate generated by `certgen.sh` to the data directory on the BSP.
* Adds `"ServerCertificate"` field to the transient config on the BSP.
* Installs `sysstat`, `jq`, and `stress-ng` to the BSP to be ran by the `rdfm-client` when daemonzied.
* Passes configuration files to `rdfm-telemetry-config` that define how and how often the above programs should be executed.
* Installs certs for the RDFM management server and keystores for the Kafka broker under `build/tmp/deploy/images/${MACHINE}/pubsub-demo`.

#### Run compose

After it's built, `cd` to `build/temp/deploy/images/${MACHINE}/pubsub-demo` and build the Kafka image:

```
DOCKER_BUILDKIT=1 docker build -t antmicro/kafka-for-rdfm .
```

**note**: You will also need the `antmicro/rdfm-server` image for the above demo. Head to [RDFM's docs](https://antmicro.github.io/rdfm/rdfm_mgmt_server.html) for build instructions.

Next, run the compose inside `pubsub-demo` directory:

```
docker compose -f docker-compose.kafka.yml up
```

Optionally, import the Keycloak configuration as described in the [README](https://github.com/antmicro/rdfm/tree/636fcf9ab5a695852b18c2cea2c5f7e0a807b412/server/deploy/pubsub-demo#keycloak-import). Clients making use of the OAUTHBEARER authetnication method won't be able to connect to the broker until it's configured. This doesn't impact the devices as they make use of JWTs issued by the RDFM management server, however it will allow client scripts such as [`rdfm-plotter`](https://github.com/antmicro/rdfm/tree/main/tools/rdfm-plotter), which make use of OAUTH, to connect to the broker.

#### Renode machine setup

How you prepare the Renode device client depends on the machine type. For example, if you were to use `rdfm-unmatched-demo` as the base, you'd need to run its [prepare script](renode/prepare-demo.sh) and follow its [README](renode/README.md) to set up network communication between your host and the simulated device. By default, this demo propagates the transient config with the host machine address of `192.168.230.1` for the management server and the broker. It's the same as in the previously mentioned README.

The last thing that needs to be done before running the daemon on the emulated machine is to set its date with `date`, for example:

```
date -s '2025-08-22 15:47:00'
```

For sending commands over UART, there's also a generated script inside `build/temp/deploy/images/${MACHINE}/pubsub-demo/rdfm_dev_eth0_config.resc` which automates some of the above.

In Renode for example, assuming the `renode` directory is located next to the `build` and `sources` and the root user is already logged in:

```
include @../build/temp/deploy/images/renodeunmatched/pubsub-demo/rdfm_dev_eth0_config.resc
```

The date is required since the CA certificate that this client will use has a date range in which it's valid.

Now it's possible to:

```
rdfm deamonize
```

Authorize the server with the [`rdfm-mgmt`](https://github.com/antmicro/rdfm/tree/main/manager) utility, from host:

```sh
CERT=build/tmp/deploy/images/$MACHINE/pubsub-demo/server/CA.crt
DEVICE_MAC=00:00:00:00:00:02 # The mac of interest is visible in the docker compose logs when the device is reaching out to the server
rdfm-mgmt --cert $CERT --url https://localhost:5000 --no-api-auth devices auth $DEVICE_MAC
```

The device will start sending its telemetry data to the broker from then on. It's possible to plot that data by using the [`rdfm-plotter`](https://github.com/antmicro/rdfm/tree/main/tools/rdfm-plotter) tool.
